name: NodeJS CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
#    paths: [ "NodeJS/**" ]
  pull_request:
    branches: [ "main" ]
#    paths: [ "NodeJS/**" ]

jobs:
  build-app-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout do código
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Instalar dependências
      run: npm install

    - name: Rodar testes
      run: npm test

    - name: Build do projeto
      run: npm run build

  docker-build:
    needs: build-app-test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Build the Docker image
      run: docker build ./NodeJS/ --file ./NodeJS/Dockerfile --tag my-nodejs-app:$(date +%s)

  deploy:
    needs: docker-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout do código
      uses: actions/checkout@v3

#    - name: Deploy via SSH
#      uses: appleboy/ssh-action@v1.0.3
#      with:
#        host: ${{ secrets.REMOTE_HOST }}
#        username: ${{ secrets.REMOTE_USER }}
#        key: ${{ secrets.SSH_PRIVATE_KEY }}
#        script: |
#          cd /caminho/do/projeto
#          git pull origin main
#          npm install
#          pm2 restart app
